# 2020/10

## 05
[LINQ クエリ演算子の実行形態～遅延実行と即時実行～ の違いを理解するための備忘録 \- Qiita](https://qiita.com/GettyAo/items/95043bf0de71e2196e2d)

### LINQクエリ演算子の実行形態の違い
クエリ演算子(Where,Select,Count,ToArray)は**遅延実行**と**即時実行**の違いがあり、その差によって思った実行結果にならないなどの問題があるため正しく理解する。

### クエリ演算子と実行形態の種類
* Where：遅延実行
* Select：遅延実行
* Count：即時実行
* ToArray：即時実行

### 遅延実行とは
武器の一覧をListに格納して攻撃力が１００以上のものを表示するプログラムで確認
```c#
    //武器のステータスを格納するクラス
    public class weapon_status
    {

        public string Name { get; set; }
        public string Attribute { get; set; }
        public int Status { get; set; }
    }

    static void Main(string[] args)
    {
        //武器のリストを作成
        var weapons = new List<weapon_status>
        {
            new weapon_status{Name = "どうの剣",Attribute = "なし",Status = 10},
            new weapon_status{Name = "はがねの剣",Attribute = "なし",Status = 50},
            new weapon_status{Name = "炎の剣",Attribute = "火",Status = 100},
            new weapon_status{Name = "ドラゴンの剣",Attribute = "竜",Status = 150},

        };

        //攻撃力が100以上のものを、強武器としてStrong_Weaponsに格納
        var Strong_Weapons = weapons.Where(x => x.Status >= 100);

        //Strong_Weaponsを表示する
        //炎の剣 , 火属性
        //ドラゴンの剣, 竜属性 ←のように表示される
        foreach (var item in Strong_Weapons)
        {
            Console.WriteLine($"{item.Name} , {item.Attribute}属性");
        }

        Console.WriteLine("--------------------------------");

        //武器のリストに新しく１つの武器を追加
        weapons.Add(new weapon_status { Name = "伝説の剣", Attribute = "光", Status = 255 });

        //Weaponsに武器を追加しただけなので、Strong_Weaponsを表示するときは
        //炎の剣 , 火属性
        //ドラゴンの剣, 竜属性 ←をのように表示される、はず？
        foreach (var item in Strong_Weapons)
        {
            Console.WriteLine($"{item.Name} , {item.Attribute}属性");
        }

        Console.ReadKey();

    }
```

実行結果
```c#
炎の剣 , 火属性
ドラゴンの剣 , 竜属性
-------------------------------
炎の剣 , 火属性
ドラゴンの剣 , 竜属性
伝説の剣 , 光属性
```

下の部分でStrong_Weapons変数にweaponsリスト型の変数から  
Whereメソッドで抽出した値を代入。このとき代入された値は「炎の剣」と「ドラゴンの剣」になる。
```c#
//攻撃力が100以上のものを、強武器としてStrong_Weaponsに格納
var Strong_Weapons = weapons.Where(x => x.Status >= 100);
```
新たにweaponsリスト型の変数に「伝説の剣」を追加する。  その後、Strong_Weapons変数の中身を再表示する。  
通常はすでにWhereメソッドによる抽出とStrong_Weaponsへの代入が終わっていると考えるため、追加された「伝説の剣」は対象外になるはずと考える。  
しかし、LINQクエリ演算子の「Where」は実行形態は**遅延実行**であるため、「Whereメソッドが呼び出されたときはまだ実行されておらず、Whereメソッドを使用したデータ(Strong_Weapons)が本当に必要になった際にクエリが実行されている。」
